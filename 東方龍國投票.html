import React, { useState, useEffect, useRef } from 'react';
import { GamePhase, GameState, Clue } from './types';
import { LEVELS, PLACEHOLDER_IMAGES, GAME_DURATION, PENALTY_SECONDS } from './constants';
import { generateSceneImage, hasApiKey } from './services/geminiService';
import { GameScene } from './components/GameScene';
import { EvidenceLog } from './components/EvidenceLog';
import { AlertTriangle, Flag, ChevronRight, Play, Wifi, WifiOff } from 'lucide-react';

const ALL_CLUES: Clue[] = LEVELS.flatMap(l => 
  l.hotspots.filter(h => h.isClue && h.clueData).map(h => h.clueData!)
);

const App: React.FC = () => {
  const [gameState, setGameState] = useState<GameState>({
    phase: GamePhase.MENU,
    currentLevelIndex: 0,
    foundClues: [],
    score: 0,
    timeRemaining: GAME_DURATION,
    generatedImages: {},
    playerName: "監察委員",
    revealedHotspots: [],
  });

  const [aiReady, setAiReady] = useState<boolean>(false);

  useEffect(() => {
    setAiReady(hasApiKey());
  }, []);

  // Track in-flight requests to avoid duplicate generation calls
  const pendingGenerations = useRef<Set<number>>(new Set());

  const currentLevel = LEVELS[gameState.currentLevelIndex];
  // If no generated image yet, fallback to placeholder
  const currentImageUrl = gameState.generatedImages[currentLevel.id] || PLACEHOLDER_IMAGES[currentLevel.id as keyof typeof PLACEHOLDER_IMAGES];

  // Image Generation & Preloading Logic
  const triggerImageLoad = async (levelId: number, prompt: string) => {
    // If we already have it or are currently fetching it, skip
    if (gameState.generatedImages[levelId] || pendingGenerations.current.has(levelId)) {
      return;
    }

    if (!hasApiKey()) return;

    pendingGenerations.current.add(levelId);
    console.log(`[Preload] Starting generation for Level ${levelId}...`);

    try {
      // Append instruction for optimization if needed
      const optimizedPrompt = prompt + " Pixel art style, clear visibility, atmospheric lighting.";
      const image = await generateSceneImage(optimizedPrompt);
      
      if (image) {
        setGameState(prev => ({
            ...prev,
            generatedImages: {
            ...prev.generatedImages,
            [levelId]: image
            }
        }));
      }
    } catch (e) {
      console.error(`Failed to load level ${levelId}`, e);
    } finally {
      pendingGenerations.current.delete(levelId);
    }
  };

  // 1. Start loading Level 1 immediately on mount
  useEffect(() => {
    const level1 = LEVELS[0];
    triggerImageLoad(level1.id, level1.prompt);
  }, []);

  // 2. Preload Next Level whenever current level changes
  useEffect(() => {
    const nextIndex = gameState.currentLevelIndex + 1;
    if (nextIndex < LEVELS.length) {
      const nextLevel = LEVELS[nextIndex];
      triggerImageLoad(nextLevel.id, nextLevel.prompt);
    }
  }, [gameState.currentLevelIndex]);

  // Timer Logic
  useEffect(() => {
    let timer: number;
    if (gameState.phase === GamePhase.PLAYING) {
        timer = window.setInterval(() => {
            setGameState(prev => {
                if (prev.timeRemaining <= 0) {
                     // Time ran out for this level
                     if (prev.currentLevelIndex < LEVELS.length - 1) {
                         // Auto advance
                         return {
                             ...prev,
                             currentLevelIndex: prev.currentLevelIndex + 1,
                             timeRemaining: GAME_DURATION, 
                             revealedHotspots: []
                         };
                     } else {
                         // End game
                         return { ...prev, phase: GamePhase.ENDING, timeRemaining: 0 };
                     }
                }
                return { ...prev, timeRemaining: prev.timeRemaining - 1 };
            });
        }, 1000);
    }
    return () => clearInterval(timer);
  }, [gameState.phase]);

  const handleStartGame = () => {
    setGameState(prev => ({ ...prev, phase: GamePhase.INTRO }));
  };

  const handleStartMission = () => {
    setGameState(prev => ({ 
        ...prev, 
        phase: GamePhase.PLAYING,
        timeRemaining: GAME_DURATION,
        foundClues: [],
        score: 0,
        revealedHotspots: []
    }));
  };

  const handleClueFound = (clueId: string) => {
    if (!gameState.foundClues.includes(clueId)) {
      setGameState(prev => ({
        ...prev,
        foundClues: [...prev.foundClues, clueId],
        score: prev.score + 100
      }));
    }
  };

  const handlePenalty = () => {
    setGameState(prev => {
        const newTime = Math.max(0, prev.timeRemaining - PENALTY_SECONDS);
        return { ...prev, timeRemaining: newTime };
    });
  };

  const handleRevealHotspot = (id: string) => {
      setGameState(prev => ({
          ...prev,
          revealedHotspots: [...prev.revealedHotspots, id]
      }));
  };

  const handleNextLevel = () => {
    if (gameState.currentLevelIndex < LEVELS.length - 1) {
      setGameState(prev => ({
        ...prev,
        currentLevelIndex: prev.currentLevelIndex + 1,
        timeRemaining: GAME_DURATION, 
        revealedHotspots: [] 
      }));
    } else {
      setGameState(prev => ({ ...prev, phase: GamePhase.ENDING }));
    }
  };

  const totalClues = ALL_CLUES.length;
  const foundCount = gameState.foundClues.length;

  const getEnding = () => {
    const percentage = (foundCount / totalClues) * 100;
    if (percentage >= 80) {
      return {
        title: "真相揭露者 (Truth Revealer)",
        desc: "你的調查報告無懈可擊。國際社會的壓力迫使東方龍國進行了徹底的民主改革。歷史將記住你的名字。",
        color: "text-blue-400",
        bg: "bg-blue-900/20"
      };
    } else if (percentage >= 40) {
      return {
        title: "平庸調查員 (Mediocre Investigator)",
        desc: "你發現了一些問題，但證據不足以撼動體制。當局承諾進行「內部檢討」，一切最終不了了之。",
        color: "text-yellow-400",
        bg: "bg-yellow-900/20"
      };
    } else {
      return {
        title: "被驅逐者 (Expelled)",
        desc: "你因證據不足且「干涉內政」被強行驅逐出境。東方龍國的鐵幕降得更低了，沒人知道裡面發生了什麼。",
        color: "text-red-600",
        bg: "bg-red-950/40"
      };
    }
  };

  // Helper component for Status Icon
  const StatusIndicator = () => (
    <div className="flex items-center gap-1.5 px-2 py-1 rounded bg-black/40 border border-gray-700/50" title={aiReady ? "AI 連線正常" : "模擬模式 (無 AI)"}>
      {aiReady ? <Wifi size={12} className="text-green-500" /> : <WifiOff size={12} className="text-gray-500" />}
      <span className={`text-[10px] uppercase font-bold tracking-wider ${aiReady ? 'text-green-500/80' : 'text-gray-500'}`}>
        {aiReady ? 'ONLINE' : 'OFFLINE'}
      </span>
    </div>
  );

  if (gameState.phase === GamePhase.MENU) {
    return (
      <div className="w-full h-screen bg-black flex flex-col items-center justify-center relative overflow-hidden">
        <div className="absolute inset-0 bg-[url('https://picsum.photos/1920/1080?grayscale&blur=4')] opacity-30"></div>
        
        {/* Connection Status Indicator */}
        <div className="absolute top-4 right-4 flex items-center gap-2 px-3 py-1 rounded-full bg-black/70 border border-gray-700 text-xs">
          {aiReady ? (
            <>
              <Wifi size={14} className="text-green-500" />
              <span className="text-green-400">AI 連線：正常</span>
            </>
          ) : (
            <>
              <WifiOff size={14} className="text-gray-500" />
              <span className="text-gray-500">模擬模式 (使用預設圖庫)</span>
            </>
          )}
        </div>

        <div className="z-10 text-center p-8 bg-black/60 backdrop-blur-md rounded-xl border border-red-900 shadow-2xl max-w-2xl animate-in fade-in zoom-in duration-500">
          <div className="mb-6 flex justify-center">
             <AlertTriangle size={64} className="text-red-600 animate-pulse" />
          </div>
          <h1 className="text-5xl md:text-6xl font-black text-white mb-2 font-serif tracking-tighter">東方龍國</h1>
          <h2 className="text-2xl md:text-3xl font-bold text-red-500 mb-8 tracking-widest">選票羅生門</h2>
          <div className="bg-black/50 p-4 rounded text-left mb-8 border-l-4 border-red-600">
            <h3 className="text-red-400 font-bold mb-2">任務簡報：</h3>
            <ul className="text-gray-300 space-y-2 text-sm">
                <li>• 限時 <span className="text-white font-bold">{GAME_DURATION} 秒</span> 完成每關調查。</li>
                <li>• 判斷錯誤或誤觸陷阱將扣除 <span className="text-red-400 font-bold">15 秒</span>。</li>
                <li>• 必須正確指認違反的民主原則。</li>
            </ul>
          </div>
          <button 
            onClick={handleStartGame}
            className="group relative px-8 py-3 bg-red-700 hover:bg-red-600 text-white font-bold tracking-widest transition-all overflow-hidden rounded"
          >
            <span className="relative z-10 flex items-center gap-2">開始潛入 <Play size={16}/></span>
            <div className="absolute inset-0 bg-red-500 transform scale-x-0 group-hover:scale-x-100 transition-transform origin-left"></div>
          </button>
        </div>
      </div>
    );
  }

  if (gameState.phase === GamePhase.INTRO) {
     return (
        <div className="w-full h-screen bg-gray-900 text-gray-200 flex items-center justify-center p-8">
            <div className="max-w-3xl w-full space-y-6 animate-in fade-in slide-in-from-bottom-10 duration-700">
                <div className="border-l-4 border-red-600 pl-6">
                    <h3 className="text-red-500 font-bold uppercase tracking-widest text-sm mb-2">機密任務 // EYES ONLY</h3>
                    <p className="text-xl font-serif leading-8">
                        目標：揭露基層選舉舞弊。<br/>
                        你的時間有限，當局的眼線無處不在。<br/>
                        <span className="text-red-400">注意：</span> 有些證據被刻意隱藏，需要與場景互動才能發現。小心陷阱，錯誤的指控會浪費寶貴的時間。
                    </p>
                </div>
                <div className="flex justify-end pt-4">
                    <button 
                        onClick={handleStartMission}
                        className="flex items-center gap-2 px-6 py-2 bg-gray-800 hover:bg-red-900 text-white border border-gray-600 transition-colors"
                    >
                        計時開始 <ChevronRight size={16}/>
                    </button>
                </div>
            </div>
        </div>
     );
  }

  if (gameState.phase === GamePhase.ENDING) {
    const ending = getEnding();
    return (
        <div className="w-full h-screen bg-black flex items-center justify-center p-4 relative">
             <div className="absolute inset-0 bg-grid-white/[0.05] bg-[size:20px_20px]"></div>
             <div className={`max-w-4xl w-full bg-gray-900 border border-gray-800 p-8 rounded-lg shadow-2xl relative z-10 ${ending.bg}`}>
                <div className="flex flex-col md:flex-row gap-8 items-center">
                    <div className="flex-1 text-center md:text-left">
                        <div className="flex items-center justify-center md:justify-start gap-2 mb-2">
                             <div className="text-sm text-gray-400 uppercase tracking-widest">最終報告</div>
                             {gameState.timeRemaining === 0 && <span className="bg-red-600 text-white text-xs px-2 py-0.5 rounded">時間耗盡</span>}
                        </div>
                        <h1 className={`text-4xl font-bold mb-4 ${ending.color}`}>{ending.title}</h1>
                        <p className="text-gray-300 text-lg leading-relaxed mb-6 font-serif">{ending.desc}</p>
                        
                        <div className="grid grid-cols-2 gap-4 mb-8 bg-black/30 p-4 rounded">
                            <div className="text-center">
                                <div className="text-3xl font-bold text-white">{foundCount} / {totalClues}</div>
                                <div className="text-xs text-gray-500">證據收集</div>
                            </div>
                            <div className="text-center">
                                <div className="text-3xl font-bold text-white">{Math.round((foundCount / totalClues) * 100)}%</div>
                                <div className="text-xs text-gray-500">完成度</div>
                            </div>
                        </div>

                        <button 
                            onClick={() => window.location.reload()}
                            className="px-6 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded transition-colors"
                        >
                            再次挑戰
                        </button>
                    </div>
                    <div className="w-full md:w-1/3 h-64 bg-black rounded-lg border border-gray-700 flex items-center justify-center overflow-hidden relative">
                         <div className="absolute inset-0 opacity-50 bg-[url('https://picsum.photos/400/600?grayscale')] bg-cover bg-center"></div>
                         <Flag size={80} className={`${ending.color} relative z-10 drop-shadow-lg`} />
                    </div>
                </div>
             </div>
        </div>
    );
  }

  // PLAYING PHASE
  return (
    <div className="w-full h-screen flex flex-col md:flex-row bg-black overflow-hidden">
      
      {/* Main Game Area */}
      <div className="flex-1 relative flex flex-col h-full">
        {/* Toolbar / Header */}
        <div className="h-14 bg-gray-900 border-b border-gray-800 flex items-center justify-between px-4 z-20 shrink-0">
            <div className="flex items-center gap-4 text-gray-300">
                <StatusIndicator />
                <div className="hidden sm:flex items-center gap-2">
                  <span className="text-red-500 font-bold">地點:</span>
                  <span>{currentLevel.location}</span>
                </div>
            </div>
            <div className="flex items-center gap-4">
                 <div className="text-xs text-gray-500 hidden md:block border-r border-gray-700 pr-4">重點：{currentLevel.mainObjective}</div>
                 <button 
                    onClick={handleNextLevel}
                    className="px-3 py-1 bg-red-800 hover:bg-red-700 text-white text-xs font-bold rounded flex items-center gap-1 transition-colors"
                 >
                    {gameState.currentLevelIndex < LEVELS.length - 1 ? "下一區域" : "提交報告"} <ChevronRight size={12}/>
                 </button>
            </div>
        </div>

        {/* Scene View */}
        <div className="flex-1 relative bg-black overflow-hidden">
            <GameScene 
                level={currentLevel}
                imageUrl={currentImageUrl}
                onClueFound={handleClueFound}
                onPenalty={handlePenalty}
                foundClues={gameState.foundClues}
                isGenerating={false}
                revealedHotspots={gameState.revealedHotspots}
                onRevealHotspot={handleRevealHotspot}
                timeRemaining={gameState.timeRemaining}
            />
        </div>
      </div>

      {/* Sidebar: Evidence Log */}
      <EvidenceLog foundClues={gameState.foundClues} allClues={ALL_CLUES} />
      
    </div>
  );
};

export default App;
